name: PR Pages previews

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, closed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pages-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  PAGES_BASE_URL: https://douglas.github.io/python-stocks/
  SITE_ROOT: site

jobs:
  build-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Prepare preview content
        env:
          SITE_ROOT: ${{ env.SITE_ROOT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PREVIEW_PATH="pr-${PR_NUMBER}"
          REPORT_DIR="$SITE_ROOT/$PREVIEW_PATH"
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"
          echo "PREVIEW_PATH=$PREVIEW_PATH" >> "$GITHUB_ENV"
          echo "REPORT_DIR=$REPORT_DIR" >> "$GITHUB_ENV"
          mkdir -p "$REPORT_DIR"
          rsync -av --delete docs/ "$REPORT_DIR"/

      - name: Generate preview dashboards
        run: |
          python -m python_stocks run --tickers SPY DIA --start 2017-01-01 --end 2018-01-01 \
            --initial 50000 --monthly 500 --strategies buy_and_hold moving_average_filter \
            --report-dir "$REPORT_DIR" --no-show

      - name: Build preview landing page
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python - <<'PY'
          import html
          import os
          from pathlib import Path

          report_dir = Path(os.environ["REPORT_DIR"])
          report_dir.mkdir(parents=True, exist_ok=True)

          pr_number = os.environ.get("PR_NUMBER") or ""

          links = []
          for path in sorted(report_dir.rglob("*")):
            if path.is_file():
              rel = path.relative_to(report_dir)
              links.append(rel.as_posix())

          link_items = "\n".join(
            f"<li><a href='{html.escape(name)}'>{html.escape(name)}</a></li>" for name in links
          )

          title = f"Preview for PR #{pr_number}" if pr_number else "Pull request preview"
          intro = "Artifacts generated by the GitHub Actions preview build. Open any file below to view the rendered dashboard assets for this pull request."

          body = f"""
          <!doctype html>
          <html lang='en'>
          <head>
            <meta charset='utf-8'>
            <title>{title}</title>
            <style>
              body {{ font-family: system-ui, -apple-system, sans-serif; margin: 2rem; line-height: 1.5; }}
              h1 {{ margin-bottom: 0.5rem; }}
              ul {{ list-style: disc; padding-left: 1.5rem; }}
              code {{ background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 4px; }}
            </style>
          </head>
          <body>
            <h1>{title}</h1>
            <p>{intro}</p>
            <ul>
              {link_items}
            </ul>
          </body>
          </html>
          """

          (report_dir / "index.html").write_text(body, encoding="utf-8")
          PY

      - name: Check out gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0

      - name: Sync preview content
        run: |
          mkdir -p "gh-pages/${PREVIEW_PATH}"
          rsync -av --delete "$REPORT_DIR"/ "gh-pages/${PREVIEW_PATH}"/

      - name: Commit and push preview
        id: commit-preview
        working-directory: gh-pages
        run: |
          PR_NUMBER="${PR_NUMBER:-${{ github.event.pull_request.number }}}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$PREVIEW_PATH"
          if git diff --cached --quiet; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "Update preview for PR #${PR_NUMBER}"
          git push origin gh-pages
          echo "changes=true" >> "$GITHUB_OUTPUT"

      - name: Record preview URL
        id: preview-url
        run: |
          echo "url=${PAGES_BASE_URL}${PREVIEW_PATH}/" >> "$GITHUB_OUTPUT"

      - name: Post preview link comment
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.preview-url.outputs.url }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const marker = '<!-- preview-url -->';
            const body = `${marker}\nðŸ“Š Preview available at ${process.env.PREVIEW_URL}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Check out gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0

      - name: Remove preview content
        id: cleanup
        env:
          PREVIEW_PATH: pr-${{ github.event.pull_request.number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        working-directory: gh-pages
        run: |
          if [ ! -d "$PREVIEW_PATH" ]; then
            echo "removed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          rm -rf "$PREVIEW_PATH"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A "$PREVIEW_PATH"

          if git diff --cached --quiet; then
            echo "removed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "Remove preview for PR #${PR_NUMBER}"
          git push origin gh-pages
          echo "removed=true" >> "$GITHUB_OUTPUT"

      - name: Update preview comment
        if: steps.cleanup.outputs.removed == 'true'
        uses: actions/github-script@v7
        env:
          PAGES_BASE_URL: ${{ env.PAGES_BASE_URL }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const marker = '<!-- preview-url -->';
            const body = `${marker}\nPreview assets for this pull request have been removed after merge/close.`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            }
