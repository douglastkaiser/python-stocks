name: Publish dashboards to Pages

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Pages
        uses: actions/configure-pages@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Prepare site structure
        run: |
          SITE_DIR=site
          echo "SITE_DIR=$SITE_DIR" >> $GITHUB_ENV
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            REPORT_DIR="$SITE_DIR/pr-${{ github.event.pull_request.number }}"
          else
            REPORT_DIR="$SITE_DIR"
          fi
          echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV
          mkdir -p "$SITE_DIR"
          rsync -av --delete docs/ "$SITE_DIR"/

      - name: Remove preview artifacts on main
        if: github.event_name != 'pull_request'
        env:
          SITE_DIR: ${{ env.SITE_DIR }}
        run: |
          if [ -d "$SITE_DIR" ]; then
            find "$SITE_DIR" -maxdepth 1 -type d -name 'pr-*' -exec rm -rf {} +
          fi

      - name: Generate sample dashboards
        run: |
          python -m python_stocks run --tickers SPY DIA --start 2017-01-01 --end 2018-01-01 \
            --initial 50000 --monthly 500 --strategies buy_and_hold moving_average_filter \
            --report-dir "$REPORT_DIR" --no-show

      - name: Build landing page
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          python - <<'PY'
          import html
          import os
          from pathlib import Path

          report_dir = Path(os.environ["REPORT_DIR"])
          report_dir.mkdir(parents=True, exist_ok=True)

          is_pr = os.environ.get("EVENT_NAME") == "pull_request"
          pr_number = os.environ.get("PR_NUMBER") or ""
          ref_name = os.environ.get("REF_NAME") or "main"

          links = []
          for path in sorted(report_dir.rglob("*")):
            if path.is_file():
              rel = path.relative_to(report_dir)
              links.append(rel.as_posix())

          link_items = "\n".join(
            f"<li><a href='{html.escape(name)}'>{html.escape(name)}</a></li>" for name in links
          )

          if is_pr:
            title = f"Preview for PR #{pr_number}"
            intro = "Artifacts generated by the GitHub Actions preview build. Open any file below to view the rendered dashboard assets for this pull request."
          else:
            title = f"Dashboards for {ref_name}"
            intro = "Latest dashboards generated from the default branch. Use the links below to open the reports produced during the publish workflow."

          body = f"""
          <!doctype html>
          <html lang='en'>
          <head>
            <meta charset='utf-8'>
            <title>{title}</title>
            <style>
              body {{ font-family: system-ui, -apple-system, sans-serif; margin: 2rem; line-height: 1.5; }}
              h1 {{ margin-bottom: 0.5rem; }}
              ul {{ list-style: disc; padding-left: 1.5rem; }}
              code {{ background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 4px; }}
            </style>
          </head>
          <body>
            <h1>{title}</h1>
            <p>{intro}</p>
            <ul>
              {link_items}
            </ul>
          </body>
          </html>
          """

          (report_dir / "index.html").write_text(body, encoding="utf-8")
          PY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

  deploy-preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages-preview
      url: ${{ steps.preview_url.outputs.url || steps.deployment.outputs.page_url }}
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
      preview_page_url: ${{ steps.preview_url.outputs.url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy preview to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          preview: true

      - name: Compute PR preview URL
        id: preview_url
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "url=${BASE_URL}pr-${PR_NUMBER}/" >> "$GITHUB_OUTPUT"

  comment-preview:
    if: github.event_name == 'pull_request'
    needs: deploy-preview
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post preview link comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `${{ needs.deploy-preview.outputs.preview_page_url || needs.deploy-preview.outputs.page_url }}`;
            const body = `ðŸ“Š Preview available at ${previewUrl}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });

  deploy:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.event.ref == 'refs/heads/main')
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
